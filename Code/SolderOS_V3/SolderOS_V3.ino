/*SolderOS V3.0 | Changed on 22/12/2019 by MarvinsTech
*/

static const unsigned char PROGMEM  press_logo[] =
{
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B11111001, B11110011, B11100111, B10001111, B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B10000000, B01000010, B00100100, B01000010, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B10000000, B01000010, B00100100, B01000010, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B11111000, B01000011, B11100111, B10000010, B00111111, B11111111, B11111111, B11111111, B11111100, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00001000, B01000010, B00100101, B00000010, B00000000, B00000000, B00000000, B00000000, B00000010, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00001000, B01000010, B00100100, B10000010, B00000000, B00000000, B00000000, B00000000, B00000001, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B11111000, B01000010, B00100100, B01000010, B00000000, B00000000, B00000000, B00000000, B00000000, B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B11000000, B11000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B01100001, B10000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00111111, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00001100, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00111110, B00000000, B00000000, B00000000, B00000000, B00011111, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11100000,
  B00000000, B00000000, B00111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111,
  B00000000, B00000001, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111,
  B00000000, B00000000, B00111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11100000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11100000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00111110, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000
};

//Bytes for the sleep mode icon toggle with CONFIG icon
static const unsigned char PROGMEM no_press_logo[] =
{
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00111110, B00000000, B00000000, B00000000, B00000000, B00011111, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11100000,
  B00000000, B00000000, B00111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111,
  B00000000, B00000001, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111,
  B00000000, B00000000, B00111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11100000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11111111, B11100000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00111110, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00001100, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00111111, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B11111001, B11110010, B00100111, B11001001, B11110000, B00000000, B00000000, B00000000, B00000000, B01100001, B10000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B10000001, B00010011, B00100100, B00001001, B00000000, B00000000, B00000000, B00000000, B00000000, B11000000, B11000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B10000001, B00010011, B00100111, B10001001, B00000000, B00000000, B00000000, B00000000, B00000000, B10000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B10000001, B00010010, B10100100, B00001001, B00000000, B00000000, B00000000, B00000000, B00000001, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B10000001, B00010010, B01100100, B00001001, B00110011, B11111111, B11111111, B11111111, B11111110, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B10000001, B00010010, B01100100, B00001001, B00010000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B11111001, B11110010, B00100100, B00001001, B11110000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000,
  B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000, B00000000
};

String Version = "Version 3.0";
float min_temp = 150;                            //This is the minimum temperature that the iron could get
float max_temp = 500;                            //This is the maximum temperature that the iron could get
float Delay = 200;                               //Refresh rate. This is the time in ms the loop runs (PID+temperature read)
int   setpoint = 250;                            //Temperature setpoint initial value
int   sleeptime = 3;                             //Wait to enter into sleep mode. Time in minutes
int   max_sleeptime = 10;                        //This is the maximum sleep time you could set the iron
int   sleeptime_adress = 2;
int   setpoint_adress_low = 3;
int   setpoint_adress_mid = 4;
int   setpoint_adress_high = 5;

float Voltage = 0.0;
int val = 0;

#include "max6675.h"              //Downlaod it here: https://github.com/adafruit/MAX6675-library
#include <SPI.h>
#include <Wire.h>
#include <Adafruit_GFX.h>         //Downlaod it here: https://github.com/adafruit/Adafruit-GFX-Library
#include <Adafruit_SSD1306.h>     //Downlaod it here: https://github.com/adafruit/Adafruit_SSD1306
#include <FastPID.h>              //Dwonload it here: https://github.com/mike-matera/FastPID
#include <EEPROM.h>
#include <math.h>
#include "pins.h"

#define OLED_RESET 8
Adafruit_SSD1306 display(OLED_RESET);
#define NUMFLAKES 5
#define XPOS 0
#define YPOS 1
#define DELTAY 2
#if (SSD1306_LCDHEIGHT != 32)
#error("Height incorrect, please fix Adafruit_SSD1306.h!");
#endif

float Kp = 7.58, Ki = 0.050, Kd = 0.86, Hz = 10;  
int output_bits = 8;                
bool output_signed = false;
FastPID myPID(Kp, Ki, Kd, Hz, output_bits, output_signed);

float temperature_read;
int logo_slide = 128;
int temp_to_print = 0;
int i = 0;
int i_prev = 0;
int var1 = 0;
bool set_temp_made = false;
bool sleep_time_set = false;
bool sleep_enabeled = true;
unsigned long sleep_time_detect = 0;

int settings = 0;

int sleep_out_count = 0;
unsigned int temp_change_count = 0;
int both_pressed_count = 0;
int sleeplogo_count = 0;
unsigned long sleepmode_VibrSensor_counter = 0;
unsigned long previousMillis_sleep = 0;
unsigned long currentMillis = 0;
unsigned long previousMillis = 0;
int set_temp_slide_counter = 32;
int set_temp_slide_counter_up = -32;
int setpoint_high = 0;
int setpoint_mid = 0;
int setpoint_low = 0;

bool sleepmode = true;
bool temp_change = false;
bool sleepmode_VibrSensor = false;

double CurrentTemp;
int adc = 0;
#define ADC_MULTISAMPLING 5
#define ADC_MULTISAMPLING_SAMPLES (1 << ADC_MULTISAMPLING)

void setup() {
  if ( EEPROM.read(1) != 1) {
    EEPROM.write(sleeptime_adress, sleeptime);
    write_setpoint_to_EEPROM();
    EEPROM.write(1, 1);
  }

  pinMode(MOSFED, OUTPUT);
  pinMode(ButtonR, INPUT);
  pinMode(ButtonL, INPUT);
  pinMode(Buzzer, OUTPUT);
  pinMode(VibrSensor, INPUT);
  pinMode(IronTemp, INPUT);
  pinMode(VoltageGauge, INPUT);
  pinMode(LED_R, OUTPUT);
  pinMode(LED_G, OUTPUT);
  pinMode(LED_B, OUTPUT);

  PCICR |= B00000010;   
  PCMSK1 |= B00000010;  

  digitalWrite(MOSFED, LOW);    
  digitalWrite(Buzzer, LOW);

  display.begin(SSD1306_SWITCHCAPVCC, 0x3C); 
  delay(200);
  analogWrite(Buzzer, 200);
  delay(100);
  analogWrite(Buzzer, LOW);

  digitalWrite(LED_R, LOW);
  digitalWrite(LED_G, HIGH);
  digitalWrite(LED_B, HIGH);

  delay(300);

  digitalWrite(LED_R, HIGH);
  digitalWrite(LED_G, HIGH);
  digitalWrite(LED_B, HIGH);

  delay(100);

  digitalWrite(LED_R, HIGH);
  digitalWrite(LED_G, LOW);
  digitalWrite(LED_B, HIGH);

  delay(300);

  digitalWrite(LED_R, HIGH);
  digitalWrite(LED_G, HIGH);
  digitalWrite(LED_B, HIGH);

  delay(100);

  digitalWrite(LED_R, HIGH);
  digitalWrite(LED_G, HIGH);
  digitalWrite(LED_B, LOW);

  delay(300);

  digitalWrite(LED_R, HIGH);
  digitalWrite(LED_G, HIGH);
  digitalWrite(LED_B, HIGH);

  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(13, 13);
  display.print("Solder OS");
  display.display();
  delay(800);

  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(7, 0);
  display.print("By Marvins");
  display.setCursor(7, 17);
  display.print("   Tech");
  display.display();
  delay(800);

  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(WHITE);
  display.setCursor(17, 0);
  display.print(" Version");
  display.setCursor(35, 17);
  display.print(" 3.0");
  display.display();
  delay(800);

  display.clearDisplay();
  display.drawBitmap(0, 0,  no_press_logo, 128, 32, 1);
  display.display();

  sleepmode_VibrSensor_counter = millis();

  sleeptime = EEPROM.read(sleeptime_adress);
  setpoint_high = EEPROM.read(setpoint_adress_low);
  setpoint_mid = EEPROM.read(setpoint_adress_mid);
  setpoint_low = EEPROM.read(setpoint_adress_high);
  setpoint = setpoint_high + setpoint_mid + setpoint_low;

}

void loop() {
  MeasureVoltage();

  if (sleeptime == 0) {
    sleep_enabeled = false;
  }

  sleep_time_detect = sleeptime * 60000;
  currentMillis = millis(); 

  if ((currentMillis - previousMillis >= Delay) &&  (!sleepmode && !temp_change && !sleepmode_VibrSensor)) {
    previousMillis += Delay;
    digitalWrite(MOSFED, LOW);         
    delayMicroseconds(300);               
    temperature_read = read_temperature();  

    uint32_t before, after;
    before = micros();
    uint8_t output = myPID.step(setpoint, temperature_read);
    after = micros();

    analogWrite(MOSFED, output);

    temp_to_print = map_temp_to_print(temperature_read);

    if ((temp_to_print < 500) && (var1 < 3)) {
      display.clearDisplay();
      display.setTextSize(2);
      display.setTextColor(WHITE);
      display.setCursor(10, 0);
      display.print("Set: ");
      display.setCursor(70, 0);
      display.print(setpoint, 1);
      display.setCursor(10, 18);
      display.print("Temp: ");
      display.setCursor(70, 18);
      display.print(temp_to_print, 1);
      display.display();
    }
    if (temp_to_print > 500) {
      display.clearDisplay();
      display.setTextSize(2);
      display.setTextColor(WHITE);
      display.setCursor(10, 0);
      display.print("Set: ");
      display.setCursor(70, 0);
      display.print(setpoint, 1);
      display.setCursor(10, 18);
      display.print("Tip ERROR");
      display.display();
      digitalWrite(LED_R, HIGH);
      digitalWrite(LED_G, HIGH);
      digitalWrite(LED_B, HIGH);
    }
    LedTemperature();
  }

  if ((digitalRead(ButtonR)) &&  (sleepmode || sleepmode_VibrSensor) && settings == 0) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    previousMillis_sleep = currentMillis;
    if (sleep_out_count > 800) {
      analogWrite(Buzzer, 200);
      delay(70);
      analogWrite(Buzzer, LOW);
      sleepmode = false;
      sleepmode_VibrSensor = false;
      sleepmode_VibrSensor = false;
      sleep_out_count = 0;
      delay(100);
    }
    sleep_out_count = sleep_out_count + 1;
  }

  if (digitalRead(ButtonR)  &&  !digitalRead(ButtonL) && !sleepmode  && !sleepmode_VibrSensor) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    previousMillis_sleep = currentMillis;

    if (sleep_out_count > 1000) {
      digitalWrite(MOSFED, LOW);
      setpoint = setpoint + 10;
      slide_set_temp_down(setpoint);
      temp_change = true;
      sleep_out_count = 0;
      if (setpoint > max_temp) {
        setpoint = max_temp;
      }
      display.clearDisplay();
      display.setTextSize(3);
      display.setTextColor(WHITE);
      display.setCursor(35, 4);
      display.print(setpoint);
      display.display();
    }
    sleep_out_count = sleep_out_count + 1;
  }

  if (!digitalRead(ButtonR)  && digitalRead(ButtonL) && !sleepmode && !sleepmode_VibrSensor) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    previousMillis_sleep = currentMillis;

    if (sleep_out_count > 1000) {
      digitalWrite(MOSFED, LOW);
      setpoint = setpoint - 10;
      slide_set_temp_up(setpoint);
      temp_change = true;
      sleep_out_count = 0;

      if (setpoint < min_temp) {
        setpoint = min_temp;
      }
      display.clearDisplay();
      display.setTextSize(3);
      display.setTextColor(WHITE);
      display.setCursor(35, 4);
      display.print(setpoint);
      display.display();
    }
    sleep_out_count = sleep_out_count + 1;
  }

  if (!digitalRead(ButtonR) && !digitalRead(ButtonL) && temp_change) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    if (temp_change_count > 15000) {
      temp_change = false;
      temp_change_count = 0;
      set_temp_made = false;
      previousMillis_sleep = currentMillis;
    }
    temp_change_count = temp_change_count + 1;
  }

  if (digitalRead(ButtonR) && digitalRead(ButtonL) && !sleepmode) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    if (both_pressed_count > 5000) {
      analogWrite(Buzzer, 200);
      delay(70);
      analogWrite(Buzzer, LOW);
      sleepmode = true;
      digitalWrite(MOSFED, LOW);
      display.clearDisplay();
      display.setTextSize(3);
      display.setTextColor(WHITE);
      display.setCursor(20, 4);
      display.print("SLEEP");
      display.display();
      delay(2000);
      both_pressed_count = 0;
    }
    both_pressed_count = both_pressed_count + 1;
  }

  if ((sleepmode || sleepmode_VibrSensor) && settings == 0) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    adc = 0;
    previousMillis_sleep = currentMillis;
    if (sleeplogo_count > 5000 && sleeplogo_count < 5005) {
      display.clearDisplay();
      display.drawBitmap(0, 0,  press_logo, 128, 32, 1);
      display.display();
    }
    if (sleeplogo_count > 10000 && sleeplogo_count < 10005) {
      display.clearDisplay();
      display.drawBitmap(0, 0,  no_press_logo, 128, 32, 1);
      display.display();
      sleeplogo_count = 0;
    }
    sleeplogo_count = sleeplogo_count + 1;
  }

  if (((currentMillis - previousMillis_sleep >= sleep_time_detect) && sleepmode_VibrSensor == false) && sleep_enabeled) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    sleepmode_VibrSensor = true;
    settings = 0;
    previousMillis_sleep = currentMillis;
    digitalWrite(MOSFED, LOW);
    display.clearDisplay();
    display.setTextSize(3);
    display.setTextColor(WHITE);
    display.setCursor(20, 4);
    display.print("SLEEP");
    display.display();
    analogWrite(Buzzer, 200);
    delay(70);
    analogWrite(Buzzer, LOW);
    delay(1000);
  }

  if (((digitalRead(ButtonL)) &&  sleepmode) && settings == 0) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    previousMillis_sleep = currentMillis;

    if (sleep_out_count > 800) {
      temp_change_count = 0;
      digitalWrite(MOSFED, LOW);
      analogWrite(Buzzer, 200);
      delay(70);
      analogWrite(Buzzer, LOW);
      settings = 1;
      sleep_out_count = 0;
      display.clearDisplay();
      display.setTextSize(1);
      display.setTextColor(WHITE);
      display.setCursor(21, 22);
      display.print("Set Sleep Time");
      display.display();
      delay(40);
      display.clearDisplay();
      display.setTextSize(1);
      display.setTextColor(WHITE);
      display.setCursor(21, 16);
      display.print("Set Sleep Time");
      display.display();
      delay(40);
      display.clearDisplay();
      display.setTextSize(1);
      display.setTextColor(WHITE);
      display.setCursor(21, 11);
      display.print("Set Sleep Time");
      display.display();
      delay(40);

    }
    sleep_out_count = sleep_out_count + 1;
  }

  if (!digitalRead(ButtonR)  &&  digitalRead(ButtonL) && settings == 1) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    previousMillis_sleep = currentMillis;

    if (sleep_out_count > 800) {
      temp_change_count = 0;
      digitalWrite(MOSFED, LOW);
      analogWrite(Buzzer, 200);
      delay(70);
      analogWrite(Buzzer, LOW);
      settings = 2;
      sleep_out_count = 0;
      slide_set_temp_down(sleeptime);
      delay(100);
    }
    sleep_out_count = sleep_out_count + 1;
  }

  if (digitalRead(ButtonR)  &&  !digitalRead(ButtonL) && settings == 1) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    previousMillis_sleep = currentMillis;

    if (sleep_out_count > 800) {
      temp_change_count = 0;
      digitalWrite(MOSFED, LOW);
      analogWrite(Buzzer, 200);
      delay(70);
      analogWrite(Buzzer, LOW);
      settings = 3;
      sleep_out_count = 0;
      display.clearDisplay();
      display.setTextSize(1);
      display.setTextColor(WHITE);
      display.setCursor(21, 22);
      display.print("Pre-set temp");
      display.display();
      delay(40);
      display.clearDisplay();
      display.setTextSize(1);
      display.setTextColor(WHITE);
      display.setCursor(21, 16);
      display.print("Pre-set temp");
      display.display();
      delay(40);
      display.clearDisplay();
      display.setTextSize(1);
      display.setTextColor(WHITE);
      display.setCursor(21, 11);
      display.print("Pre-set temp");
      display.display();
      delay(40);

    }
    sleep_out_count = sleep_out_count + 1;
  }

  if (digitalRead(ButtonR)  &&  !digitalRead(ButtonL) && settings == 3) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    previousMillis_sleep = currentMillis;

    if (sleep_out_count > 800) {
      digitalWrite(MOSFED, LOW);
      analogWrite(Buzzer, 200);
      delay(70);
      analogWrite(Buzzer, LOW);
      settings = 1;
      sleep_out_count = 0;
      temp_change_count = 0;
      display.clearDisplay();
      display.setTextSize(1);
      display.setTextColor(WHITE);
      display.setCursor(21, 22);
      display.print("Set Sleep Time");
      display.display();
      delay(40);
      display.clearDisplay();
      display.setTextSize(1);
      display.setTextColor(WHITE);
      display.setCursor(21, 16);
      display.print("Set Sleep Time");
      display.display();
      delay(40);
      display.clearDisplay();
      display.setTextSize(1);
      display.setTextColor(WHITE);
      display.setCursor(21, 11);
      display.print("Set Sleep Time");
      display.display();
      delay(40);
    }
    sleep_out_count = sleep_out_count + 1;
  }

  if (!digitalRead(ButtonR)  &&  digitalRead(ButtonL) && settings == 3) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    previousMillis_sleep = currentMillis;
    if (sleep_out_count > 800) {
      digitalWrite(MOSFED, LOW);
      analogWrite(Buzzer, 200);
      delay(70);
      analogWrite(Buzzer, LOW);
      settings = 4;
      sleep_out_count = 0;
      temp_change_count = 0;
      slide_set_temp_down(setpoint);
      delay(300);
    }
    sleep_out_count = sleep_out_count + 1;
  }

  if (digitalRead(ButtonR)  &&  !digitalRead(ButtonL) && settings == 2) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    previousMillis_sleep = currentMillis;

    if (sleep_out_count > 1000) {
      digitalWrite(MOSFED, LOW);
      sleep_out_count = 0;
      temp_change_count = 0;
      sleeptime = sleeptime + 1;
      EEPROM.write(sleeptime_adress, sleeptime);
      temp_change_count = 0;

      if (sleeptime > max_sleeptime) {
        sleeptime = 0;
        EEPROM.write(sleeptime_adress, sleeptime);
        display.clearDisplay();
        display.setTextSize(3);
        display.setTextColor(WHITE);
        display.setCursor(35, 4);
        display.print("OFF");
        display.display();
        sleep_enabeled = false;
      } else {
        slide_set_temp_down(sleeptime);
        sleep_enabeled = true;
      }
    }
    sleep_out_count = sleep_out_count + 1;
  }

  if (!digitalRead(ButtonR)  &&  digitalRead(ButtonL) && settings == 2) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    previousMillis_sleep = currentMillis;

    if (sleep_out_count > 1000) {
      digitalWrite(MOSFED, LOW);
      sleep_out_count = 0;
      temp_change_count = 0;
      sleeptime = sleeptime - 1;
      EEPROM.write(sleeptime_adress, sleeptime);
      temp_change_count = 0;
      if (sleeptime < 1)
      {
        sleeptime = 0;
        EEPROM.write(sleeptime_adress, sleeptime);
        display.clearDisplay();
        display.setTextSize(3);
        display.setTextColor(WHITE);
        display.setCursor(35, 4);
        display.print("OFF");
        display.display();
        sleep_enabeled = false;
      } else {
        slide_set_temp_up(sleeptime);
        sleep_enabeled = true;
      }
    }
    sleep_out_count = sleep_out_count + 1;
  }

  if (digitalRead(ButtonR)  &&  !digitalRead(ButtonL) && settings == 4) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    previousMillis_sleep = currentMillis;

    if (sleep_out_count > 1000) {
      digitalWrite(MOSFED, LOW);
      setpoint = setpoint + 10;
      write_setpoint_to_EEPROM();
      slide_set_temp_down(setpoint);
      temp_change = true;
      sleep_out_count = 0;
      temp_change_count = 0;
      if (setpoint > max_temp) {
        setpoint = max_temp;
        write_setpoint_to_EEPROM();
      }
      display.clearDisplay();
      display.setTextSize(3);
      display.setTextColor(WHITE);
      display.setCursor(35, 4);
      display.print(setpoint);
      display.display();

    }
    sleep_out_count = sleep_out_count + 1;
  }

  if (!digitalRead(ButtonR)  &&  digitalRead(ButtonL) && settings == 4) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    previousMillis_sleep = currentMillis;

    if (sleep_out_count > 1000) {
      digitalWrite(MOSFED, LOW);
      setpoint = setpoint - 10;
      write_setpoint_to_EEPROM();
      slide_set_temp_up(setpoint);
      temp_change = true;
      sleep_out_count = 0;
      temp_change_count = 0;
      if (setpoint < min_temp) {
        setpoint = min_temp;
        write_setpoint_to_EEPROM();
      }
      display.clearDisplay();
      display.setTextSize(3);
      display.setTextColor(WHITE);
      display.setCursor(35, 4);
      display.print(setpoint);
      display.display();
    }
    sleep_out_count = sleep_out_count + 1;
  }

  if (!digitalRead(ButtonR) && !digitalRead(ButtonL) && settings != 0) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
    if (temp_change_count > 25000) {
      settings = 0;
      temp_change_count = 0;
      previousMillis_sleep = currentMillis;
      display.clearDisplay();
      display.setTextSize(3);
      display.setTextColor(WHITE);
      display.setCursor(16, 4);
      display.print("SAVED");
      display.display();
      delay(1000);
    }
    temp_change_count = temp_change_count + 1;
  }
}

void write_setpoint_to_EEPROM() {
  if (setpoint < 250) {
    EEPROM.write(setpoint_adress_low, setpoint);
    EEPROM.write(setpoint_adress_mid, 0);
    EEPROM.write(setpoint_adress_high, 0);
  }
  else if (setpoint > 250 && setpoint < 500) {
    setpoint_high = setpoint - 255;
    setpoint_mid = 255;
    setpoint_low = 0;
    EEPROM.write(setpoint_adress_low, setpoint_low);
    EEPROM.write(setpoint_adress_mid, setpoint_mid);
    EEPROM.write(setpoint_adress_high, setpoint_high);
  } else {
    setpoint_high = setpoint - 255;
    setpoint_mid = setpoint_high - 255;
    setpoint_low = 255 - setpoint_mid;
    EEPROM.write(setpoint_adress_low, setpoint_low);
    EEPROM.write(setpoint_adress_mid, setpoint_mid);
    EEPROM.write(setpoint_adress_high, setpoint_high);
    setpoint = setpoint_high + setpoint_mid + setpoint_low;
  }
}

void slide_set_temp_down(int tempe) {
  while (set_temp_slide_counter >= 4) {
    display.clearDisplay();
    display.setTextSize(3);
    display.setTextColor(WHITE);
    display.setCursor(36, set_temp_slide_counter);
    display.print(tempe);
    display.display();
    set_temp_slide_counter = set_temp_slide_counter - 4;
    delayMicroseconds(1);
  }
  set_temp_slide_counter = 32;
}

void slide_set_temp_up(int tempe) {
  while (set_temp_slide_counter_up <= 4) {
    display.clearDisplay();
    display.setTextSize(3);
    display.setTextColor(WHITE);
    display.setCursor(36, set_temp_slide_counter_up);
    display.print(tempe);
    display.display();
    set_temp_slide_counter_up = set_temp_slide_counter_up + 4;
    delayMicroseconds(1);
  }
  set_temp_slide_counter_up = -32;
}

int map_temp_to_print(int temp) {
  while (i < 800) {
    if (i_prev < temp && temp < i) {
      return i;
      i = 800;
    }
    i_prev = i;
    i = i + 5 ;
  }
  i = 0;
}

float read_temperature() {
  adc = 0;
  for (int i = 0; i < ADC_MULTISAMPLING_SAMPLES; ++i)
    adc += analogRead(IronTemp);
  adc = adc >> ADC_MULTISAMPLING;
  if (adc < 100) {
    double temp =  1.11289 * adc - 8.58536; 
    CurrentTemp += (temp - CurrentTemp) * 0.05;
  }
  if (adc > 100) {
    double temp =  (220.373 * (log(adc))) - 932.544; 
    CurrentTemp += (temp - CurrentTemp) * 0.05;
  }
  return (CurrentTemp);
}

ISR(PCINT1_vect) {
  previousMillis_sleep = currentMillis;
  sleepmode_VibrSensor = false;
  delay(500);
}

void MeasureVoltage() {
  val = analogRead(VoltageGauge);
  Voltage = (val / 1600.00) * 120;
}

void LedTemperature() {
  int TemperatureMaped1 = map(temp_to_print, 0, 100, 255, 0);
  int TemperatureMaped2 = map(temp_to_print, 101, 200, 0, 255);
  int TemperatureMaped3 = map(temp_to_print, 101, 200, 255, 0);
  int TemperatureMaped4 = map(temp_to_print, 201, 300, 255, 0);
  int TemperatureMaped5 = map(temp_to_print, 301, 400, 0, 255);
  int TemperatureMaped6 = map(temp_to_print, 301, 400, 255, 0);
  int TemperatureMaped7 = map(temp_to_print, 401, 500, 255, 0);

  if (temp_to_print > 400) {
    analogWrite(LED_R, TemperatureMaped7);
    digitalWrite(LED_G, HIGH);
    digitalWrite(LED_B, HIGH);
  } else if (temp_to_print > 300) {
    analogWrite(LED_R, TemperatureMaped6);
    digitalWrite(LED_G, HIGH);
    analogWrite(LED_B, TemperatureMaped5);
  } else if (temp_to_print > 200) {
    digitalWrite(LED_R, HIGH);
    digitalWrite(LED_G, HIGH);
    analogWrite(LED_B, TemperatureMaped4);
  } else if (temp_to_print > 100) {
    digitalWrite(LED_R, HIGH);
    analogWrite(LED_G, TemperatureMaped2);
    analogWrite(LED_B, TemperatureMaped3);
  } else if (temp_to_print < 100) {
    digitalWrite(LED_R, HIGH);
    analogWrite(LED_G, TemperatureMaped1);
    digitalWrite(LED_B, HIGH);
  }
}
